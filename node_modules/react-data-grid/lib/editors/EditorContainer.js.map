{"version":3,"file":"EditorContainer.js","sourceRoot":"","sources":["../../src/editors/EditorContainer.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, { KeyboardEvent, useRef, useState, useLayoutEffect, useCallback, useEffect } from 'react';\nimport clsx from 'clsx';\n\nimport { CalculatedColumn, Editor, CommitEvent } from '../common/types';\nimport SimpleTextEditor from './SimpleTextEditor';\nimport ClickOutside from './ClickOutside';\nimport { InteractionMasksProps } from '../masks/InteractionMasks';\nimport { preventDefault } from '../utils';\n\ntype SharedInteractionMasksProps<R, SR> = Pick<InteractionMasksProps<R, SR>,\n  | 'scrollLeft'\n  | 'scrollTop'\n  | 'rowHeight'\n>;\n\nexport interface EditorContainerProps<R, SR> extends SharedInteractionMasksProps<R, SR> {\n  rowIdx: number;\n  row: R;\n  column: CalculatedColumn<R, SR>;\n  onCommit: (e: CommitEvent) => void;\n  onCommitCancel: () => void;\n  firstEditorKeyPress: string | null;\n  top: number;\n  left: number;\n}\n\nexport default function EditorContainer<R, SR>({\n  rowIdx,\n  column,\n  row,\n  rowHeight,\n  left,\n  top,\n  onCommit,\n  onCommitCancel,\n  scrollLeft,\n  scrollTop,\n  firstEditorKeyPress: key\n}: EditorContainerProps<R, SR>) {\n  const editorRef = useRef<Editor>(null);\n  const changeCommitted = useRef(false);\n  const changeCanceled = useRef(false);\n  const [isValid, setValid] = useState(true);\n  const prevScrollLeft = useRef(scrollLeft);\n  const prevScrollTop = useRef(scrollTop);\n  const isUnmounting = useRef(false);\n\n  const getInputNode = useCallback(() => editorRef.current?.getInputNode(), []);\n\n  const commitCancel = useCallback(() => {\n    changeCanceled.current = true;\n    onCommitCancel();\n  }, [onCommitCancel]);\n\n  useLayoutEffect(() => {\n    const inputNode = getInputNode();\n\n    if (inputNode instanceof HTMLElement) {\n      inputNode.focus();\n    }\n    if (inputNode instanceof HTMLInputElement) {\n      inputNode.select();\n    }\n  }, [getInputNode]);\n\n  // close editor when scrolling\n  useEffect(() => {\n    if (scrollLeft !== prevScrollLeft.current || scrollTop !== prevScrollTop.current) {\n      commitCancel();\n    }\n  }, [commitCancel, scrollLeft, scrollTop]);\n\n  useEffect(() => () => {\n    isUnmounting.current = true;\n  }, []);\n\n  // commit changes when editor is closed\n  useEffect(() => () => {\n    if (isUnmounting.current && !changeCommitted.current && !changeCanceled.current) {\n      commit();\n    }\n  });\n\n  function getInitialValue() {\n    const value = row[column.key as keyof R];\n    if (key === 'Delete' || key === 'Backspace') {\n      return '';\n    }\n    if (key === 'Enter') {\n      return value;\n    }\n\n    return key || value;\n  }\n\n  function isCaretAtBeginningOfInput(): boolean {\n    const inputNode = getInputNode();\n    return inputNode instanceof HTMLInputElement\n      && inputNode.selectionEnd === 0;\n  }\n\n  function isCaretAtEndOfInput(): boolean {\n    const inputNode = getInputNode();\n    return inputNode instanceof HTMLInputElement\n      && inputNode.selectionStart === inputNode.value.length;\n  }\n\n  function editorHasResults(): boolean {\n    return editorRef.current?.hasResults?.() ?? false;\n  }\n\n  function editorIsSelectOpen(): boolean {\n    return editorRef.current?.isSelectOpen?.() ?? false;\n  }\n\n  function isNewValueValid(value: unknown): boolean {\n    const isValid = editorRef.current?.validate?.(value);\n    if (typeof isValid === 'boolean') {\n      setValid(isValid);\n      return isValid;\n    }\n    return true;\n  }\n\n  function preventDefaultNavigation(key: string): boolean {\n    return (key === 'ArrowLeft' && !isCaretAtBeginningOfInput())\n      || (key === 'ArrowRight' && !isCaretAtEndOfInput())\n      || (key === 'Escape' && editorIsSelectOpen())\n      || (['ArrowUp', 'ArrowDown'].includes(key) && editorHasResults());\n  }\n\n  function commit(): void {\n    if (!editorRef.current) return;\n    const updated = editorRef.current.getValue();\n    if (isNewValueValid(updated)) {\n      changeCommitted.current = true;\n      const cellKey = column.key;\n      onCommit({ cellKey, rowIdx, updated });\n    }\n  }\n\n  function onKeyDown(e: KeyboardEvent) {\n    if (preventDefaultNavigation(e.key)) {\n      e.stopPropagation();\n    } else if (['Enter', 'Tab', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {\n      commit();\n    } else if (e.key === 'Escape') {\n      commitCancel();\n    }\n  }\n\n  function createEditor() {\n    // return custom column editor or SimpleEditor if none specified\n    if (column.editor) {\n      return (\n        <column.editor\n          ref={editorRef}\n          column={column}\n          value={getInitialValue() as R[keyof R & string] & R[keyof R & number] & R[keyof R & symbol]}\n          row={row}\n          height={rowHeight}\n          onCommit={commit}\n          onCommitCancel={commitCancel}\n          onOverrideKeyDown={onKeyDown}\n        />\n      );\n    }\n\n    return (\n      <SimpleTextEditor\n        ref={editorRef as unknown as React.RefObject<SimpleTextEditor>}\n        column={column}\n        value={getInitialValue() as string}\n        onCommit={commit}\n      />\n    );\n  }\n\n  const className = clsx('rdg-editor-container', {\n    'rdg-editor-invalid': !isValid\n  });\n\n  return (\n    <ClickOutside onClickOutside={commit}>\n      <div\n        className={className}\n        style={{ height: rowHeight, width: column.width, left, top }}\n        onKeyDown={onKeyDown}\n        onContextMenu={preventDefault}\n      >\n        {createEditor()}\n      </div>\n    </ClickOutside>\n  );\n}\n"]}